<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>One Review Evaluation - {{ team_name }}</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-pVnKQp8z+...etc"
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />

<style>
:root {
  --primary: #6A0DAD;
  --secondary: #F9DDEB;
  --accent: #C7A4E0;
  --background: #F8F9FC;
  --text-dark: #2E2E2E;
  --text-light: #ffffff;
}

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(120deg, var(--background), #ffffff);
  margin: 0;
  padding: 40px;
  color: var(--text-dark);
}

/* ---------------- HEADER ---------------- */
.header {
  text-align: center;
  margin-bottom: 40px;
}

.header h2 {
  font-size: 28px;
  color: var(--primary);
  margin-bottom: 5px;
  font-weight: 700;
}

.header p {
  color: #555;
  font-size: 16px;
}

/* ---------------- TABLE BASE ---------------- */
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--text-light);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

th {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: var(--text-light);
  padding: 15px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.5px;
}

td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid #e5d8f5;
  vertical-align: top;
  color: var(--text-dark);
}

tr:hover {
  background-color: var(--secondary);
}

/* ---------------- INPUTS ---------------- */
input[type="number"] {
  width: 60px;
  text-align: center;
  border: 1px solid var(--accent);
  border-radius: 8px;
  padding: 5px;
  transition: 0.3s ease;
}

input[type="number"]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 5px var(--accent);
}

/* ---------------- SECTION HEADERS ---------------- */
.subheader {
  background-color: var(--accent);
  font-weight: bold;
  font-style: italic;
  text-align: left;
  color: var(--text-light);
}

/* ---------------- TOTAL ROW ---------------- */
.total-row {
  background: linear-gradient(90deg, var(--primary), var(--accent)) !important;
  color: var(--text-light);
  font-weight: bold;
}

/* ---------------- TITLE BOX ---------------- */
.title-box {
  text-align: center;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.6em;
  font-weight: 700;
  margin: 30px 0 20px;
}

/* ---------------- BUTTONS ---------------- */
.submit-container {
  text-align: center;
  margin-top: 30px;
}

.submit-button {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: var(--text-light);
  border: none;
  padding: 15px 35px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s ease;
  box-shadow: 0 4px 12px rgba(106, 13, 173, 0.3);
  margin: 5px;
}

.submit-button:hover {
  background: var(--accent);
  box-shadow: 0 6px 18px rgba(106, 13, 173, 0.4);
}

/* ---------------- FINAL SUMMARY ---------------- */
#final-summary {
  display: none;
  margin-top: 30px;
  background: var(--text-light);
  border-radius: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  padding: 15px;
}

#final-summary table {
  width: 100%;
  border-collapse: collapse;
}

#final-summary th,
#final-summary td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

#final-summary th {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: var(--text-light);
}

/* ---------------- RESPONSIVE ---------------- */
@media (max-width: 768px) {
  table, th, td {
    font-size: 14px;
  }
  input[type="number"] {
    width: 50px;
    padding: 4px;
  }
}
</style>
</head>
<body>

  <!-- ================= HEADER ================= -->
  <div class="header">
    <h2>
      <i class="fas fa-users"></i>
      Team Members Details
    </h2>
    <p>Review 1 Evaluation – {{ team_name }}</p>
  </div>

  <!-- ================= TEAM DETAILS TABLE ================= -->
  <table>
    <thead>
      <tr>
        <th>S.No.</th>
        <th>Batch No.</th>
        <th>Reg. No.</th>
        <th>Student Name</th>
        <th>Project Supervisor</th>
      </tr>
    </thead>

    <tbody>
      {% for member in team_members %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ member.batch_no }}</td>
        <td>{{ member.reg_no }}</td>
        <td>{{ member }}</td>
        <td>{{ member.supervisor }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">No team members found</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ================= TITLE ================= -->
  <div class="title-box">
    Team Members Contribution and Performance Evaluation
  </div>

  <!-- ================= FORM START ================= -->
  <form method="POST" id="evaluation-form">
    {% csrf_token %}
    <table>
      <thead>
        <tr>
          <th>Evaluation Component</th>
          <th>Max Marks</th>
          {% for member in team_members %}
            <th>{{ forloop.counter }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>

        <!-- ================= PROBLEM FORMULATION ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Problem Formulation</td>
        </tr>
        <tr>
          <td>Aim of the Project</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Justification for Carrying out the Project</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= KNOWLEDGE ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">
            Knowledge / Understanding of the Project
          </td>
        </tr>
        <tr>
          <td>Review of the Literature - Knowledge about Existing Method</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Review of literature is presented in a logical Manner</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= OBJECTIVES & METHODOLOGY ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">
            Objectives and Methodology of Proposed Work
          </td>
        </tr>
        <tr>
          <td>Problem Identification</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Objective of the Project</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Selection of appropriate techniques and tools</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= WORK PROGRESS ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Work Progress</td>
        </tr>
        <tr>
          <td>Technical Design</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Test Results & Discussion of Individual Modules</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= SOCIETY & ENVIRONMENT ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">
            Society and Environmental Relevance
          </td>
        </tr>
        <tr>
          <td>Society and Environmental Relevance</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= PRESENTATION ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Presentation</td>
        </tr>
        <tr>
          <td>Organization of the Presentation</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Communication of Ideas</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= TEAM WORK ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Team Work</td>
        </tr>
        <tr>
          <td>Team Work</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= FUTURE WORK ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">
            Planning for Future Work
          </td>
        </tr>
        <tr>
          <td>Estimate of the Proposed Work</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Originality of the Proposed Work</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Recognize the need for Lifelong Learning</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= VIVA VOCE ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Viva Voce</td>
        </tr>
        <tr>
          <td>Answering Questions</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Conceptual Understanding</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>
        <tr>
          <td>Relevance</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= EXTRA ================= -->
        <tr class="subheader">
          <td colspan="{{ team_members|length|add:'2' }}">Extra Evaluation</td>
        </tr>
        <tr>
          <td>Innovation / Creativity</td>
          <td>5</td>
          {% for member in team_members %}
            <td><input type="number" min="0" max="5" value="0"></td>
          {% endfor %}
        </tr>

        <!-- ================= TOTAL ================= -->
        <tr class="total-row">
          <td><b>Total</b></td>
          <td><b>100</b></td>
          {% for member in team_members %}
            <td id="total-{{ forloop.counter0 }}">0</td>
          {% endfor %}
        </tr>

      </tbody>
    </table>
    <!-- ================= ACTION BUTTONS ================= -->
    <div class="submit-container">
      <button type="button" class="submit-button" id="confirm-btn">
        ✅ Confirm Marks
      </button>

      <button type="button"
              class="submit-button"
              id="download-btn"
              style="display:none;">
        ⬇️ Download DOCX
      </button>
    </div>

  </form>
  <!-- ================= FORM END ================= -->

  <!-- ================= FINAL EVALUATION SUMMARY ================= -->
  <div id="final-summary">
    <h3>Final Evaluation Summary - {{ team_name }}</h3>

    <table>
      <thead>
        <tr>
          <th>Team Member</th>
          <th>C1</th><th>C2</th><th>C3</th><th>C4</th><th>C5</th>
          <th>C6</th><th>C7</th><th>C8</th><th>C9</th><th>C10</th>
          <th>C11</th><th>C12</th><th>C13</th><th>C14</th><th>C15</th>
          <th>C16</th><th>C17</th><th>C18</th><th>C19</th><th>C20</th>
          <th>Total</th>
        </tr>
      </thead>

      <tbody id="summary-body">
        <!-- JS will populate -->
      </tbody>
    </table>
  </div>
<script>
document.addEventListener("DOMContentLoaded", function () {

  const MAX_MARK = 5;
  const MIN_MARK = 0;
  const totalInputs = 20;
  const autoFillLimit = 16;

  const inputs = document.querySelectorAll("input[type='number']");
  const memberCount = {{ team_members|length }};

  /* ---------- TEAM MEMBERS ---------- */
  const teamMembers = [
    {% for member in team_members %}
      "{{ member }}",
    {% endfor %}
  ];

  /* ---------- INIT INPUT METADATA ---------- */
  inputs.forEach((inp, idx) => {
    inp.dataset.manual = "false";
    inp.dataset.memberIndex = idx % memberCount;
    inp.dataset.criteriaIndex = Math.floor(idx / memberCount);
  });

  /* ---------- SANITIZE ---------- */
  function sanitizeInput(input) {
    let value = parseInt(input.value);
    if (isNaN(value)) value = 0;
    if (value > MAX_MARK) value = MAX_MARK;
    if (value < MIN_MARK) value = MIN_MARK;
    input.value = value;
  }

  /* ---------- TOTAL ---------- */
  function calculateTotal() {
    for (let m = 0; m < memberCount; m++) {
      let sum = 0;
      inputs.forEach(inp => {
        if (parseInt(inp.dataset.memberIndex) === m) {
          sum += parseInt(inp.value) || 0;
        }
      });
      document.getElementById(`total-${m}`).textContent = sum;
    }
  }

  /* ---------- INPUT HANDLING ---------- */
  inputs.forEach(inp => {

    inp.addEventListener("input", function () {
      sanitizeInput(this);

      const memberIndex = parseInt(this.dataset.memberIndex);
      const criteriaIndex = parseInt(this.dataset.criteriaIndex);

      /* AUTO FILL */
      if (memberIndex === 0 && criteriaIndex < autoFillLimit) {
        inputs.forEach(other => {
          if (
            parseInt(other.dataset.memberIndex) > 0 &&
            parseInt(other.dataset.criteriaIndex) === criteriaIndex &&
            other.dataset.manual === "false"
          ) {
            other.value = this.value;
          }
        });
      }

      if (memberIndex > 0) {
        this.dataset.manual = "true";
      }

      calculateTotal();
    });

    inp.addEventListener("paste", function (e) {
      e.preventDefault();
      let pasted = parseInt((e.clipboardData || window.clipboardData).getData("text"));
      if (isNaN(pasted)) pasted = 0;
      if (pasted > MAX_MARK) pasted = MAX_MARK;
      this.value = pasted;
      this.dispatchEvent(new Event("input"));
    });
  });

  calculateTotal();

  /* ---------- BUTTONS ---------- */
  const confirmBtn = document.getElementById("confirm-btn");
  const downloadBtn = document.getElementById("download-btn");
  const summaryBody = document.getElementById("summary-body");
  const finalSummary = document.getElementById("final-summary");

  /* ---------- CONFIRM ---------- */
  confirmBtn.addEventListener("click", function () {

    summaryBody.innerHTML = "";

    for (let m = 0; m < memberCount; m++) {
      let rowHTML = `<td>${teamMembers[m]}</td>`;

      for (let c = 0; c < totalInputs; c++) {
        const inp = Array.from(inputs).find(i =>
          parseInt(i.dataset.memberIndex) === m &&
          parseInt(i.dataset.criteriaIndex) === c
        );
        rowHTML += `<td>${inp ? inp.value : 0}</td>`;
      }

      rowHTML += `<td>${document.getElementById(`total-${m}`).textContent}</td>`;

      const row = document.createElement("tr");
      row.innerHTML = rowHTML;
      summaryBody.appendChild(row);
    }

    finalSummary.style.display = "block";
    downloadBtn.style.display = "inline-block";

    window.scrollTo({ top: finalSummary.offsetTop, behavior: "smooth" });
  });

  /* ---------- DOWNLOAD DOCX (FIXED) ---------- */
  downloadBtn.addEventListener("click", function () {

    const savedEvaluations = {};

    {% for member in team_members %}
    savedEvaluations["team_member-{{ member }}"] = [];
    for (let i = 0; i < totalInputs; i++) {
      const inp = Array.from(inputs).find(input =>
        parseInt(input.dataset.memberIndex) === {{ forloop.counter0 }} &&
        parseInt(input.dataset.criteriaIndex) === i
      );
      savedEvaluations["team_member-{{ member }}"].push(inp ? inp.value : 0);
    }
    {% endfor %}

    fetch("{% url 'save_evaluation_review1' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        team_name: "{{ team_name }}",
        evaluations: savedEvaluations
      })
    })
    .then(response => response.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "{{ team_name }}_Review1.docx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => {
      console.error(err);
      alert("❌ DOCX download failed");
    });
  });

});
</script>


</body>
</html>
