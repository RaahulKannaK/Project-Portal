{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guide Hub - Review Paper</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
body{
  font-family: Montserrat, sans-serif;
  background:#f8f9fc;
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.dashboard-wrapper{
  width:95%;
  height:90vh;
  display:flex;
  background:#6a0dad;
  border-radius:18px;
  overflow:hidden;
}
.sidebar{
  width:260px;
  padding:25px;
  background:linear-gradient(180deg,#6a0dad,#c7a4e0);
  color:#fff;
}
.sidebar a{
  display:block;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  color:#fff;
  text-decoration:none;
}
.sidebar a.active,.sidebar a:hover{
  background:#f9ddeb;
  color:#2e2e2e;
}
.main-content{
  flex:1;
  padding:25px;
  background:#f8f9fc;
  overflow-y:auto;
}
.main-card{
  background:linear-gradient(135deg,#6a0dad,#c7a4e0);
  color:#fff;
  padding:20px;
  border-radius:14px;
}
.glass-btn{
  background:#f9ddeb;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.split-view{
  display:none;
  grid-template-columns:70% 30%;
  gap:20px;
  margin-top:20px;
}
.split-view.active{display:grid;}
.color-btn{
  width:26px;
  height:26px;
  border-radius:50%;
  border:2px solid #555;
  margin-right:6px;
  cursor:pointer;
}
.color-btn.active{outline:3px solid #000;}
.pdf-toolbar{
  position:absolute;
  top:8px;
  right:8px;
  z-index:1000;
}
.pdf-toolbar button{margin-left:4px;}
.tag-item{
  background:#f9ddeb;
  padding:8px;
  border-radius:8px;
  margin-bottom:8px;
  font-size:13px;
}
.highlighted{cursor:pointer;}
#reviewWrapper{transform-origin: top left;}
</style>
</head>

<body>
<div class="dashboard-wrapper">

<!-- SIDEBAR -->
<div class="sidebar">
  <h5>Review Paper</h5>
  <a href="{% url 'zero_ppt' %}">PPT</a>
  <a href="{% url 'zero_form' %}">Review Form</a>
  <a href="{% url 'zero_review' %}" class="active">Review Paper</a>
  <a href="{% url 'zero_base' %}">Base Paper</a>
</div>

<!-- MAIN -->
<div class="main-content">

<div class="main-card mb-3">
<h5>Review Paper</h5>

{% if html_content %}
<button class="glass-btn" id="openReviewBtn">
  <i class="fa fa-eye"></i> View Review Paper
</button>
{% else %}
<p class="mb-0">‚ö†Ô∏è Abstract PDF not uploaded yet</p>
{% endif %}
</div>

<!-- SPLIT VIEW -->
<div id="splitView" class="split-view">

<!-- REVIEW PANEL -->
<div class="bg-white rounded p-2 position-relative" style="height:75vh; overflow:auto;">
  <div class="pdf-toolbar">
    <button class="btn btn-secondary btn-sm" onclick="zoomIn()">+</button>
    <button class="btn btn-secondary btn-sm" onclick="zoomOut()">‚àí</button>
    <button class="btn btn-warning btn-sm" onclick="toggleEraser()">Eraser</button>
    <button class="btn btn-danger btn-sm" onclick="closeViewer()">Close</button>
  </div>

  <div id="reviewWrapper">
    <div id="reviewContent">
      {{ html_content|safe }}
    </div>
  </div>
</div>

<!-- REMARK PANEL -->
<div class="bg-light p-3 rounded" style="height:75vh; overflow-y:auto;">
<h6>Annotation Panel</h6>

<label>Selected Text</label>
<textarea id="selectedText" class="form-control mb-2" rows="2" readonly></textarea>

<label>Highlight Color</label>
<div class="mb-2">
  <button class="color-btn active" data-color="#ffe066" style="background:#ffe066"></button>
  <button class="color-btn" data-color="#ff6b6b" style="background:#ff6b6b"></button>
  <button class="color-btn" data-color="#69db7c" style="background:#69db7c"></button>
</div>

<button class="glass-btn w-100 mb-2" onclick="applyHighlight()">
  <i class="fa fa-highlighter"></i> Highlight
</button>

<label>Detected Heading</label>
<input id="detectedHeading" class="form-control mb-2" readonly>

<div class="mb-2">
{% for h in sub_headings %}
<button type="button" class="badge bg-secondary me-1 mb-1"
onclick="document.getElementById('detectedHeading').value='{{ h|escapejs }}'">
{{ h }}
</button>
{% endfor %}
</div>

<label>Remark</label>
<textarea id="remarkText" class="form-control mb-2"></textarea>

<button class="glass-btn w-100" onclick="saveTag()">Save Remark</button>

<hr>
<h6>Saved Remarks</h6>
<div id="savedTags"></div>

<hr>
<button class="glass-btn w-100 mt-2" onclick="sendRemarksToStudent()">
<i class="fa fa-paper-plane"></i> Send Remarks to Student
</button>

</div>
</div>
</div>
</div>

<!-- ‚úÖ DB SAVED REMARKS JSON -->
<script>
const DB_SAVED_REMARKS = [
{% for r in saved_remarks %}
  {
    heading: "{{ r.heading|escapejs }}",
    remark: "{{ r.remark|escapejs }}",
    color: "{{ r.color }}"
  },
{% endfor %}
];
</script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

let selectedRange=null;
let selectedColor="#ffe066";
let tags=[];
let zoom=1;
let eraser=false;
let sending=false;

const STORAGE_KEY="zero_review_annotations";

const splitView=document.getElementById("splitView");
const openBtn=document.getElementById("openReviewBtn");
const reviewContent=document.getElementById("reviewContent");
const reviewWrapper=document.getElementById("reviewWrapper");
const selectedTextBox=document.getElementById("selectedText");
const detectedHeading=document.getElementById("detectedHeading");
const remarkText=document.getElementById("remarkText");

/* OPEN */
openBtn?.addEventListener("click",()=>{
  splitView.classList.add("active");
  restoreData();
  applyDBHighlights();   // üî• APPLY DB HIGHLIGHTS
});

/* CLOSE */
window.closeViewer=()=>{
  splitView.classList.remove("active");
};

/* COLOR PICK */
document.querySelectorAll(".color-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".color-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedColor=btn.dataset.color;
  };
});

/* TEXT SELECT */
reviewContent.addEventListener("mouseup",()=>{
  if(eraser) return;
  const sel=window.getSelection();
  if(sel && !sel.isCollapsed){
    selectedRange=sel.getRangeAt(0);
    selectedTextBox.value=sel.toString();
  }
});

/* HIGHLIGHT */
window.applyHighlight=()=>{
  if(!selectedRange) return alert("Select text first");
  try{
    const span=document.createElement("span");
    span.className="highlighted";
    span.style.backgroundColor=selectedColor;
    span.appendChild(selectedRange.extractContents());
    selectedRange.insertNode(span);
    window.getSelection().removeAllRanges();
    selectedRange=null;
    persistData();
  }catch{
    alert("Select smaller text");
  }
};

/* ERASER */
window.toggleEraser=()=>{
  eraser=!eraser;
  alert(eraser?"Eraser ON":"Eraser OFF");
};

reviewContent.addEventListener("click",e=>{
  if(eraser && e.target.classList.contains("highlighted")){
    e.target.replaceWith(...e.target.childNodes);
    persistData();
  }
});

/* ZOOM */
window.zoomIn=()=>{zoom+=0.1;applyZoom();};
window.zoomOut=()=>{zoom=Math.max(0.4,zoom-0.1);applyZoom();};
function applyZoom(){
  reviewWrapper.style.transform=`scale(${zoom})`;
}

/* TAG SAVE */
window.saveTag=()=>{
  if(!detectedHeading.value || !remarkText.value){
    alert("Heading & remark required");
    return;
  }
  tags.push({
    heading:detectedHeading.value,
    remark:remarkText.value,
    color:selectedColor
  });
  detectedHeading.value="";
  remarkText.value="";
  selectedTextBox.value="";
  renderTags();
  persistData();
};

function renderTags(){
  const box=document.getElementById("savedTags");
  box.innerHTML="";
  tags.forEach((t,i)=>{
    box.innerHTML+=`
      <div class="tag-item" style="border-left:5px solid ${t.color}">
        <b>${t.heading}</b><br>${t.remark}
        <button class="btn btn-sm btn-danger float-end"
        onclick="deleteTag(${i})">X</button>
      </div>`;
  });
}

window.deleteTag=(i)=>{
  tags.splice(i,1);
  renderTags();
  persistData();
};

/* STORAGE */
function persistData(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({
    tags,
    content:reviewContent.innerHTML
  }));
}
function restoreData(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){
    const d=JSON.parse(raw);
    tags=d.tags||[];
    if(d.content) reviewContent.innerHTML=d.content;
  }else{
    tags=DB_SAVED_REMARKS; // üî• LOAD FROM DB
  }
  renderTags();
}

/* üî• AUTO APPLY DB HIGHLIGHTS */
function applyDBHighlights(){
  if(!DB_SAVED_REMARKS || DB_SAVED_REMARKS.length===0) return;

  let html=reviewContent.innerHTML;

  DB_SAVED_REMARKS.forEach(r=>{
    if(!r.heading) return;
    const safe=r.heading.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
    const regex=new RegExp(safe,"g");
    html=html.replace(regex,match=>{
      return `<span class="highlighted" style="background-color:${r.color};" title="${r.remark}">${match}</span>`;
    });
  });

  reviewContent.innerHTML=html;
}

/* SEND TO BACKEND */
window.sendRemarksToStudent=()=>{
  if(sending || tags.length===0) return;
  sending=true;

  fetch("{% url 'save_zeroth_remark' %}",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-CSRFToken":"{{ csrf_token }}"
    },
    body:JSON.stringify({remarks:tags})
  })
  .then(r=>r.json())
  .then(d=>{
    sending=false;
    if(d.status==="success"){
      alert("Remarks sent ‚úÖ");
      tags=[];
      renderTags();
      localStorage.removeItem(STORAGE_KEY);
    }else{
      alert("Failed ‚ùå");
    }
  })
  .catch(()=>{
    sending=false;
    alert("Server error");
  });
};

});
</script>

</body>
</html>
