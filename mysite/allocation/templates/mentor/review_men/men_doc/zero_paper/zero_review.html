{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guide Hub - Review Paper</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
body{
  font-family: Montserrat, sans-serif;
  background:#f8f9fc;
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.dashboard-wrapper{
  width:95%;
  height:90vh;
  display:flex;
  background:#6a0dad;
  border-radius:18px;
  overflow:hidden;
}
.sidebar{
  width:260px;
  padding:25px;
  background:linear-gradient(180deg,#6a0dad,#c7a4e0);
  color:#fff;
}
.sidebar a{
  display:block;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  color:#fff;
  text-decoration:none;
}
.sidebar a.active,.sidebar a:hover{
  background:#f9ddeb;
  color:#2e2e2e;
}
.main-content{
  flex:1;
  padding:25px;
  background:#f8f9fc;
  overflow-y:auto;
}
.main-card{
  background:linear-gradient(135deg,#6a0dad,#c7a4e0);
  color:#fff;
  padding:20px;
  border-radius:14px;
}
.glass-btn{
  background:#f9ddeb;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.split-view{
  display:none;
  grid-template-columns:70% 30%;
  gap:20px;
  margin-top:20px;
}
.split-view.active{display:grid;}

.color-btn{
  width:26px;
  height:26px;
  border-radius:50%;
  border:2px solid #555;
  margin-right:6px;
  cursor:pointer;
}
.color-btn.active{outline:3px solid #000;}

.highlighted{
  padding:2px;
  cursor:pointer;
}

.pdf-toolbar{
  position:absolute;
  top:8px;
  right:8px;
  z-index:1000;
}
.pdf-toolbar button{margin-left:4px;}

.tag-item{
  background:#f9ddeb;
  padding:8px;
  border-radius:8px;
  margin-bottom:8px;
  font-size:13px;
}
</style>
</head>

<body>
<div class="dashboard-wrapper">

<!-- SIDEBAR -->
<div class="sidebar">
  <h5>Review Paper</h5>
  <a href="{% url 'zero_ppt' %}">PPT</a>
  <a href="{% url 'zero_form' %}">Review Form</a>
  <a href="{% url 'zero_review' %}" class="active">Review Paper</a>
  <a href="{% url 'zero_base' %}">Base Paper</a>
</div>

<!-- MAIN -->
<div class="main-content">
<div class="main-card">
<h5>Review Paper</h5>

{% if html_path %}
<button class="glass-btn view-btn" data-file="{{ html_path }}">
<i class="fa fa-eye"></i> View Review Paper
</button>
{% endif %}
</div>

<!-- SPLIT VIEW -->
<div id="splitView" class="split-view">

<!-- PDF VIEW -->
<div class="bg-white rounded p-2 position-relative" style="height:75vh;">
<div class="pdf-toolbar">
  <button class="btn btn-secondary btn-sm" onclick="zoomIn()">+</button>
  <button class="btn btn-secondary btn-sm" onclick="zoomOut()">âˆ’</button>
  <button class="btn btn-warning btn-sm" onclick="toggleEraser()">Eraser</button>
  <button class="btn btn-danger btn-sm" onclick="closeViewer()">Close</button>
</div>
<iframe id="pdfFrame" style="width:100%;height:100%;border:none;"></iframe>
</div>

<!-- ANNOTATION PANEL -->
<div class="bg-light p-3 rounded">
<h6>Annotation Panel</h6>

<label>Selected Text</label>
<textarea id="selectedText" class="form-control mb-2" rows="2" readonly></textarea>

<label>Highlight Color</label>
<div class="mb-2">
  <button class="color-btn active" data-color="#ffe066" style="background:#ffe066"></button>
  <button class="color-btn" data-color="#ff6b6b" style="background:#ff6b6b"></button>
  <button class="color-btn" data-color="#69db7c" style="background:#69db7c"></button>
</div>

<button class="glass-btn w-100 mb-2" onclick="applyHighlight()">
<i class="fa fa-highlighter"></i> Highlight
</button>

<label>Detected Heading</label>
<input id="detectedHeading" class="form-control mb-2" readonly>

<div class="mb-2">
{% for h in sub_headings %}
<button class="badge bg-secondary heading-tag" onclick="detectedHeading.value='{{ h }}'">{{ h }}</button>
{% endfor %}
</div>

<label>Remark</label>
<textarea id="remarkText" class="form-control mb-2"></textarea>

<button class="glass-btn w-100" onclick="saveTag()">Save Tag</button>

<hr>
<h6>Saved Remarks</h6>
<div id="savedTags"></div>

<!-- âœ… UPDATED REMARKS BUTTON -->
<hr>
<button class="glass-btn w-100 mt-2" onclick="sendRemarksToStudent()">
<i class="fa fa-paper-plane"></i> Send Remarks to Student
</button>

</div>
</div>
</div>
</div>

<script>
/* =========================================================
   GLOBAL STATE
   ========================================================= */
let selectedRange = null;
let selectedColor = "#ffe066";
let zoom = 1;
let eraser = false;
let tags = [];
let sending = false; // ðŸ”’ prevents double send

const STORAGE_KEY = "review_annotations_v1";

const iframe = document.getElementById("pdfFrame");
const selectedTextBox = document.getElementById("selectedText");

/* =========================================================
   COLOR PICKER
   ========================================================= */
document.querySelectorAll(".color-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".color-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedColor = btn.dataset.color;
  };
});

/* =========================================================
   VIEW PDF
   ========================================================= */
document.querySelector(".view-btn").onclick = e => {
  iframe.src = e.target.closest("button").dataset.file;
  document.getElementById("splitView").classList.add("active");

  iframe.onload = () => {
    restoreData();       // âœ… restore highlights + tags
    bindSelection();
    bindEraser();
  };
};

function closeViewer() {
  persistData();         // âœ… save before closing
  iframe.src = "";
  document.getElementById("splitView").classList.remove("active");
}

/* =========================================================
   ZOOM
   ========================================================= */
function zoomIn() {
  zoom += 0.1;
  iframe.contentDocument.body.style.zoom = zoom;
}

function zoomOut() {
  zoom = Math.max(0.3, zoom - 0.1);
  iframe.contentDocument.body.style.zoom = zoom;
}

/* =========================================================
   ERASER
   ========================================================= */
function toggleEraser() {
  eraser = !eraser;
  alert(eraser ? "ðŸ§½ Eraser ON" : "âœï¸ Eraser OFF");
}

/* =========================================================
   TEXT SELECTION
   ========================================================= */
function bindSelection() {
  iframe.contentDocument.addEventListener("mouseup", () => {
    const sel = iframe.contentWindow.getSelection();
    if (sel && !sel.isCollapsed) {
      selectedRange = sel.getRangeAt(0);
      selectedTextBox.value = sel.toString();
      detectHeading(sel.toString());
    }
  });
}

/* =========================================================
   HEADING DETECTION
   ========================================================= */
function detectHeading(text) {
  if (typeof DOCUMENT_MAP === "undefined") {
    detectedHeading.value = "Unknown";
    return;
  }

  const key = text.toLowerCase().split(" ").slice(0, 6).join(" ");
  for (let i = DOCUMENT_MAP.length - 1; i >= 0; i--) {
    if (DOCUMENT_MAP[i].heading.toLowerCase().includes(key)) {
      detectedHeading.value = DOCUMENT_MAP[i].heading;
      return;
    }
  }
  detectedHeading.value = "Unknown";
}

/* =========================================================
   APPLY HIGHLIGHT
   ========================================================= */
function applyHighlight() {
  if (!selectedRange) {
    alert("Select text first");
    return;
  }

  const span = iframe.contentDocument.createElement("span");
  span.className = "pdf-highlight";
  span.style.backgroundColor = selectedColor;

  selectedRange.surroundContents(span);
  iframe.contentWindow.getSelection().removeAllRanges();

  persistData(); // âœ… save highlighted HTML
}

/* =========================================================
   ERASER HANDLER
   ========================================================= */
function bindEraser() {
  iframe.contentDocument.addEventListener("click", e => {
    if (!eraser) return;

    const target = e.target;
    if (target.classList.contains("pdf-highlight")) {
      target.replaceWith(...target.childNodes);
      persistData();
      e.stopPropagation();
    }
  });
}

/* =========================================================
   SAVE TAG
   ========================================================= */
function saveTag() {
  if (!detectedHeading.value) {
    alert("Heading required");
    return;
  }

  tags.push({
    heading: detectedHeading.value,
    remark: remarkText.value,
    color: selectedColor
  });

  remarkText.value = "";
  renderTags();
  persistData();
}

/* =========================================================
   RENDER TAGS
   ========================================================= */
function renderTags() {
  const box = document.getElementById("savedTags");
  box.innerHTML = "";

  tags.forEach((t, i) => {
    box.innerHTML += `
      <div class="tag-item" style="border-left:5px solid ${t.color}">
        <strong>${t.heading}</strong><br>${t.remark}
        <button class="btn btn-sm btn-danger float-end"
          onclick="tags.splice(${i},1);renderTags();persistData()">X</button>
      </div>
    `;
  });
}

/* =========================================================
   LOCAL STORAGE (HIGHLIGHTS + TAGS)
   ========================================================= */
function persistData() {
  if (!iframe.contentDocument) return;

  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    html: iframe.contentDocument.body.innerHTML, // âœ… highlighted HTML
    tags: tags
  }));
}

function restoreData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw || !iframe.contentDocument) return;

  const data = JSON.parse(raw);

  if (data.html) {
    iframe.contentDocument.body.innerHTML = data.html;
  }

  tags = data.tags || [];
  renderTags();
}

/* =========================================================
   SEND REMARKS â€” NO DOUBLE SEND, NO DATA LOSS
   ========================================================= */
function sendRemarksToStudent() {
  if (tags.length === 0) {
    alert("No remarks to send");
    return;
  }

  if (sending) return; // ðŸ”’ block duplicate click

  sending = true;

  const payload = {
    remarks: tags,
    sent_at: new Date().toISOString()
  };

  fetch("{% url 'save_zeroth_remark' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    sending = false;

    if (data.status === "success") {
      alert("Remarks sent successfully âœ…");
      // âŒ DO NOT clear tags or highlights (as you requested)
    } else {
      alert("Failed to send remarks âŒ");
    }
  })
  .catch(err => {
    sending = false;
    console.error(err);
    alert("Error sending remarks");
  });
}
</script>



</body>
</html>
